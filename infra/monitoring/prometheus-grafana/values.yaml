global:
  imagePullSecrets:
    - name: ghcr-token

prometheus:
  enabled: true
  prometheusSpec:
    retention: 5d
    storageSpec:
      emptyDir: {}
    resources:
      requests:
        memory: 256Mi
        cpu: 100m
      limits:
        memory: 512Mi
        cpu: 200m
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    ruleSelectorNilUsesHelmValues: false
    scrapeInterval: 60s
    evaluationInterval: 60s

grafana:
  enabled: true
  # Disable automatic datasource creation since we define our own
  defaultDatasourceEnabled: false

  env:
    GF_SERVER_ROOT_URL: "https://janusc.duckdns.org/grafana"
    GF_SERVER_SERVE_FROM_SUB_PATH: "true"

  extraSecretMounts:
    - name: grafana-github-oauth
      secretName: github-oauth-secret
      defaultMode: 0440
      mountPath: /etc/secrets/grafana-github-oauth
      readOnly: true
  # GitHub OAuth configuration using grafana.ini format (matches official documentation)
  # Reference: https://grafana.com/docs/grafana/latest/setup-grafana/configure-access/configure-authentication/github/#configuration-options
  # Note: Using $__file{} to reference secrets from mounted files
  grafana.ini:
    auth.github:
      enabled: true
      allow_sign_up: true
      client_id: $__file{/etc/secrets/grafana-github-oauth/client_id}
      client_secret: $__file{/etc/secrets/grafana-github-oauth/client_secret}
      scopes: read:org,user:email
      auth_url: https://github.com/login/oauth/authorize
      token_url: https://github.com/login/oauth/access_token
      api_url: https://api.github.com/user
      auto_assign_org_role: Viewer
      # Assign Admin role to januschung, Viewer to all others
      # GitHub OAuth provides: login, email, organizations, teams
      role_attribute_path: login=='januschung' && 'Admin' || 'Viewer'
      allow_assign_grafana_admin: true
  resources:
    requests:
      memory: 128Mi
      cpu: 50m
    limits:
      memory: 512Mi
      cpu: 100m
  ingress:
    enabled: true
    ingressClassName: traefik
    hosts:
      - janusc.duckdns.org
    path: /grafana
    pathType: Prefix
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
      traefik.ingress.kubernetes.io/router.tls.certresolver: le

  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          access: proxy
          url: http://prometheus-grafana-kube-pr-prometheus:9090
          editable: true
          jsonData:
            httpMethod: POST
            timeInterval: 60s
        - name: Alertmanager
          type: alertmanager
          access: proxy
          url: http://prometheus-grafana-kube-pr-alertmanager:9093
          editable: true
          jsonData:
            handleGrafanaManagedAlerts: false
            implementation: prometheus
        - name: Loki
          type: loki
          uid: loki
          access: proxy
          url: http://loki:3100
          editable: true
          jsonData:
            timeout: 60
            httpHeaderName1: "X-Scope-OrgID"
            oauthPassThru: false
          secureJsonData:
            httpHeaderValue1: default
  # Dashboard provisioning for application log monitoring
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'Application Logs'
          orgId: 1
          folder: 'Application Logs'
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/application-logs
dashboards:
    application-logs:
      # Existing dashboards from Grafana.com
      loki-logs-performance:
        gnetId: 13639
        revision: 1
        datasource: Loki
      logs-explorer:
        gnetId: 15107
        revision: 1
        datasource: Loki
      job-winner-dashboard:
        datasource: 
          - name: DS_PROMETHEUS
            value: Prometheus
          - name: DS_LOKI
            value: Loki
        json: |
          {
            "annotations": {
              "list": [
                {
                  "builtIn": 1,
                  "datasource": { "type": "grafana", "uid": "-- Grafana --" },
                  "enable": true,
                  "hide": true,
                  "name": "Annotations & Alerts",
                  "type": "dashboard"
                }
              ]
            },
            "editable": true,
            "fiscalYearStartMonth": 0,
            "graphTooltip": 0,
            "id": null,
            "links": [],
            "panels": [
              {
                "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
                "fieldConfig": { "defaults": { "color": { "mode": "palette-classic" }, "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": 0 }, { "color": "red", "value": 80 }] } }, "overrides": [] },
                "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
                "id": 2,
                "targets": [
                  {
                    "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
                    "expr": "sum by (pod) (rate(container_cpu_usage_seconds_total{namespace=\"job-winner\", container!=\"\"}[5m])) / sum by (pod) (kube_pod_container_resource_requests{namespace=\"job-winner\", resource=\"cpu\"}) * 100",
                    "refId": "A"
                  }
                ],
                "title": "CPU",
                "type": "timeseries"
              },
              {
                "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
                "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
                "id": 3,
                "targets": [
                  {
                    "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
                    "expr": "sum by (pod) (container_memory_working_set_bytes{namespace=\"job-winner\", container!=\"\"}) / 1024 / 1024",
                    "refId": "A"
                  }
                ],
                "title": "Memory",
                "type": "timeseries"
              },
              {
                "datasource": { "type": "loki", "uid": "${DS_LOKI}" },
                "gridPos": { "h": 22, "w": 24, "x": 0, "y": 8 },
                "id": 1,
                "options": { "enableLogDetails": true, "sortOrder": "Descending" },
                "targets": [
                  {
                    "datasource": { "type": "loki", "uid": "${DS_LOKI}" },
                    "expr": "{service_name=\"job-winner-backend\"} | regexp `(?P<time>\\S+)\\s+(?P<level>[A-Z]+)\\s+.*:\\s+(?P<msg>.*)` | line_format \"{{.time}} [{{.level}}] - {{.msg}}\" | level=~\"$level\" |~ \"(?i)$search\"",
                    "refId": "A"
                  }
                ],
                "title": "Backend",
                "type": "logs"
              }
            ],
            "schemaVersion": 42,
            "templating": {
              "list": [
                { "label": "log level", "name": "level", "options": [ { "selected": true, "text": "INFO", "value": "INFO" }, { "text": "WARN", "value": "WARN" }, { "text": "ERROR", "value": "ERROR" } ], "query": "INFO, WARN, ERROR", "type": "custom" },
                { "label": "Search Logs", "name": "search", "query": "", "type": "textbox" }
              ]
            },
            "title": "Job Winner",
            "uid": "job-winner-dash",
            "version": 1
          }
