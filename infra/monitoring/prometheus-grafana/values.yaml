global:
  imagePullSecrets:
    - name: ghcr-token

prometheus:
  enabled: true
  prometheusSpec:
    retention: 5d
    storageSpec:
      emptyDir: {}
    resources:
      requests:
        memory: 256Mi
        cpu: 100m
      limits:
        memory: 512Mi
        cpu: 200m
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    ruleSelectorNilUsesHelmValues: false
    scrapeInterval: 60s
    evaluationInterval: 60s

grafana:
  enabled: true
  # Disable automatic datasource creation since we define our own
  defaultDatasourceEnabled: false

  env:
    GF_SERVER_ROOT_URL: "https://janusc.duckdns.org/grafana"
    GF_SERVER_SERVE_FROM_SUB_PATH: "true"

  extraSecretMounts:
    - name: grafana-github-oauth
      secretName: github-oauth-secret
      defaultMode: 0440
      mountPath: /etc/secrets/grafana-github-oauth
      readOnly: true
  # GitHub OAuth configuration using grafana.ini format (matches official documentation)
  # Reference: https://grafana.com/docs/grafana/latest/setup-grafana/configure-access/configure-authentication/github/#configuration-options
  # Note: Using $__file{} to reference secrets from mounted files
  grafana.ini:
    auth.github:
      enabled: true
      allow_sign_up: true
      client_id: $__file{/etc/secrets/grafana-github-oauth/client_id}
      client_secret: $__file{/etc/secrets/grafana-github-oauth/client_secret}
      scopes: read:org,user:email
      auth_url: https://github.com/login/oauth/authorize
      token_url: https://github.com/login/oauth/access_token
      api_url: https://api.github.com/user
      auto_assign_org_role: Viewer
      # Assign Admin role to januschung, Viewer to all others
      # GitHub OAuth provides: login, email, organizations, teams
      role_attribute_path: login=='januschung' && 'Admin' || 'Viewer'
      allow_assign_grafana_admin: true
  resources:
    requests:
      memory: 128Mi
      cpu: 50m
    limits:
      memory: 512Mi
      cpu: 100m
  ingress:
    enabled: true
    ingressClassName: traefik
    hosts:
      - janusc.duckdns.org
    path: /grafana
    pathType: Prefix
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
      traefik.ingress.kubernetes.io/router.tls.certresolver: le

  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          access: proxy
          url: http://prometheus-grafana-kube-pr-prometheus:9090
          editable: true
          jsonData:
            httpMethod: POST
            timeInterval: 60s
        - name: Alertmanager
          type: alertmanager
          access: proxy
          url: http://prometheus-grafana-kube-pr-alertmanager:9093
          editable: true
          jsonData:
            handleGrafanaManagedAlerts: false
            implementation: prometheus
        - name: Loki
          type: loki
          uid: loki
          access: proxy
          url: http://loki:3100
          editable: true
          jsonData:
            timeout: 60
            httpHeaderName1: "X-Scope-OrgID"
            oauthPassThru: false
          secureJsonData:
            httpHeaderValue1: default
  # Dashboard provisioning for application log monitoring
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'Application Logs'
          orgId: 1
          folder: 'Application Logs'
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/application-logs
  dashboards:
    application-logs:
      # Loki & Promtail - Logs and Performance (Popular general purpose dashboard)
      loki-logs-performance:
        gnetId: 13639
        revision: 1
        datasource: Loki
      # Logs Explorer - Advanced log exploration
      logs-explorer:
        gnetId: 15107
        revision: 1
        datasource: Loki
